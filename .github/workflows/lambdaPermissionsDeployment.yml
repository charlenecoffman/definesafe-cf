name: CFDeployments
on:
  workflow_run:
    workflows: ["LambdaDeployments"]
    branches: [main]
    types: 
      - completed

jobs:
  addPermissions:
    runs-on: ubuntu-18.04
    steps:
      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@v1
        with:
          AWS-ACCESS-KEY-ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS-SECRET-ACCESS-KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS-REGION: us-east-1
      - name: Check Policy Existance
        run: |
          policy=$(aws iam list-policies --query 'Policies[?PolicyName == "CreatePlanPermissions"].Role' --output text --region "us-east-1")
          echo "::set-env name=POLICY::$policy"
      - name: Create Plan Permissions If Does Not Exist
        if: env.POLICY == ''
        run: |
          echo "{\"Version\": \"2012-10-17\",\"Statement\": [{\"Effect\": \"Allow\", \"Action\": \"sts:AssumeRole\", \"Principal\": {\"Service\": \"lambda.amazonaws.com\"}}]}" > policyJson.json
          policy=$(aws iam create-policy --policy-name "CreatePlanPermissions" --policy-document file://policyJson.json --tags Key=Solution,Value=DefineSafe)
          echo $policy > returnObject.json
          sleep 10s
          aws iam attach-role-policy --role-name "AWSLambdaBasicExecutionRole-CreatePlan" --policy-arn "$(jq -r '.Policy.Arn' returnObject.json)"